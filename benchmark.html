<!doctype html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpenCC WASM vs opencc-js Benchmark</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <div class="container">
    <header>
      <div class="brand">
        <h1>OpenCC Benchmark</h1>
      </div>
    </header>

    <div class="card-section">
      <p style="margin-bottom: 16px; color: var(--text-sub);">输入需要转换的文本（建议较长），选择配置后比较两者耗时。</p>

      <div class="options">
        <div>
          <label for="configName">配置（如 s2t.json）</label>
          <input id="configName" value="s2t.json"
            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: #f9fafb;" />
        </div>
      </div>

      <label for="inputText">输入文本</label>
      <textarea id="inputText" style="min-height: 120px;">鼠标里面的硅二极管坏了，导致光标分辨率降低。</textarea>

      <div class="toolbar">
        <button id="run" class="btn btn-primary">运行 Benchmark</button>
      </div>
    </div>

    <div class="card-section">
      <h2>结果</h2>
      <div class="output-box" id="output" style="min-height: 200px;"></div>
    </div>

    <div class="footer">
      本頁基於 <a href="https://www.npmjs.com/package/opencc-wasm" target="_blank" rel="noreferrer">opencc-wasm</a>
    </div>
  </div>

  <script type="module">
    import OpenCCWasm from "./vendor/opencc-wasm/esm/index.js";

    // 动态加载 opencc-js（仅从本地 vendor，未安装则给出提示）
    async function loadOpenCCJS() {
      const url = "./vendor/opencc-js/esm/full.js";
      let lastErr = null;
      try {
        const mod = await import(new URL(url, window.location.href).href);
        const api = mod.default || mod.OpenCC || mod;
        if (!api?.Converter) throw new Error("Converter not found in opencc-js module");
        return api;
      } catch (e) {
        lastErr = e;
      }
      throw lastErr || new Error("opencc-js not available");
    }

    document.getElementById("run").onclick = async () => {
      const cfg = document.getElementById("configName").value.trim();
      const text = document.getElementById("inputText").value;
      const out = document.getElementById("output");
      if (!cfg) {
        out.textContent = "配置不能为空";
        return;
      }

      const lines = [];
      lines.push(`输入长度: ${text.length} 字符`);

      // WASM
      try {
        const tLoad0 = performance.now();
        // Use local wasm path explicit trick if needed, but here we assume prepare.js ran correctly
        // and defaults work or we rely on the same fix as index.html if it fails.
        // For consistency let's try default first.
        const wasmConv = OpenCCWasm.Converter({
          config: cfg,
          wasmPath: './vendor/opencc-wasm/dist/opencc-wasm.wasm'
        });
        await wasmConv("预热");
        const tLoad1 = performance.now();
        const runs = [];
        let wasmResult = "";
        for (let i = 0; i < 5; i++) {
          const t0 = performance.now();
          wasmResult = await wasmConv(text);
          const t1 = performance.now();
          runs.push(t1 - t0);
        }
        const avg = runs.reduce((a, b) => a + b, 0) / runs.length;
        lines.push(`WASM 加载: ${(tLoad1 - tLoad0).toFixed(2)} ms，转换(5次): ${runs.map(n => n.toFixed(2)).join(", ")} ms，平均: ${avg.toFixed(2)} ms`);
        lines.push(`WASM 输出: ${wasmResult}`);
      } catch (e) {
        lines.push("WASM 失败: " + e);
        console.error(e);
      }

      // JS（仅支持部分 from/to 映射）
      const configToLocale = {
        "s2t.json": { from: "cn", to: "t" },
        "t2s.json": { from: "t", to: "cn" },
      };
      if (configToLocale[cfg]) {
        try {
          const tLoad0 = performance.now();
          const OpenCCJS = await loadOpenCCJS();
          const jsConv = OpenCCJS.Converter(configToLocale[cfg]);
          const tLoad1 = performance.now();
          const runs = [];
          let jsResult = "";
          for (let i = 0; i < 5; i++) {
            const t0 = performance.now();
            jsResult = jsConv(text);
            const t1 = performance.now();
            runs.push(t1 - t0);
          }
          const avg = runs.reduce((a, b) => a + b, 0) / runs.length;
          lines.push(`opencc-js 加载: ${(tLoad1 - tLoad0).toFixed(2)} ms，转换(5次): ${runs.map(n => n.toFixed(2)).join(", ")} ms，平均: ${avg.toFixed(2)} ms`);
          lines.push(`opencc-js 输出: ${jsResult}`);
        } catch (e) {
          lines.push("opencc-js 运行失败: " + e);
        }
      } else {
        lines.push("opencc-js 仅示例对比 s2t.json / t2s.json，其它配置暂不对比。");
      }

      out.textContent = lines.join("\n");
    };
  </script>
</body>

</html>