<!doctype html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpenCC WASM vs opencc-js Benchmark</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <div class="container">
    <header>
      <div class="brand">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 152 152">
          <path fill="currentColor"
            d="M64.7 9.7c-.4.3.3 1.7 1.5 3 1.9 2 2.3 3.6 2.3 8.6v6.2L53 29.7c-8.5 1.3-17.4 2.7-19.7 3.1-3.8.8-4.3.7-6.6-1.9-3.1-3.6-6.2-4-5-.7 1.5 4.2.6 10.7-2.3 16.4-2.6 5.2-2.7 5.8-1.3 8.2.8 1.5 2.1 2.7 2.9 2.7 2 0 4.7-5.8 6.3-13.5l1.3-6.4L39 35.8c18.6-3.1 45.1-5.8 61-6 17.9-.3 18.7.2 12.4 7.2-2 2.2-3.5 4.3-3.2 4.5.3.3 3-.6 6.2-2.1 3.9-1.8 6.9-2.5 9.8-2.2 5.9.4 6.3-2.1 1.1-7.4-5.3-5.5-8.3-6.9-12.4-5.8-1.9.4-9.5 1.1-16.9 1.5-7.4.3-15.4.8-17.7 1.2l-4.3.5.6-3.3c.4-1.9 1.3-4.7 2.1-6.2 1.1-2.3 1.2-3.1.2-4.3-2.5-3.1-11.4-5.5-13.2-3.7z" />
          <path fill="currentColor"
            d="M87 43.5c-1.4.8-3.4 1.4-4.5 1.4s-9.3 1.5-18.3 3.3c-13.9 2.7-16.7 3-19.4 2-5-1.9-5.7.1-1.4 4.4 4.1 4.1 3.7 4.1 16.6-.4 9.1-3.3 26-6.5 27.3-5.3.7.7-7.9 11.8-12.1 15.4-1.9 1.8-2.2 1.8-4.4.3-4.9-3.5-5-1.4-.3 5.5 5.2 7.6 4.9 8.6-3.2 9.4-3.8.4-16.1 2-27.6 3.6-15.1 2.2-21.2 2.7-22.6 1.9-5.2-2.7-6.8.1-2.4 4.2 5.1 4.6 6.1 4.8 13.2 2.1C34 89 55.2 85 68.7 83.6l6.2-.7.7 3.7c1 5.5-.3 25.2-2.1 31.2-.9 2.9-2.3 5.6-3.2 5.9-1.4.6-8.4-.5-15-2.3-4.5-1.2-2.3 1.6 3.3 4.3 3.8 1.8 6.3 3.8 8 6.5 1.3 2.1 3.1 3.8 4 3.8 2.9 0 6.3-4.8 8.6-12.1 2-6.5 2.3-9.4 2.3-24.2V83l3.4-.6c3.6-.7 28.3.1 40.4 1.2 6.4.7 6.7.6 6.7-1.5 0-1.7-1.3-2.8-5.5-4.7-5-2.3-6-2.4-10.7-1.5-2.9.6-12.1 1.3-20.4 1.7l-15.1.7-2.3-4.7-2.2-4.7 6.8-6.4c3.8-3.5 9.3-7.7 12.1-9.2 2.9-1.5 5.3-3.4 5.3-4 0-1.4-7.7-7.3-9.4-7.3-.6.1-2.2.7-3.6 1.5z" />
        </svg>
        <div>
          <h1>OpenCC Benchmark</h1>
          <span>性能基準測試</span>
        </div>
      </div>
    </header>

    <div class="card-section">
      <p style="margin-bottom: 16px; color: var(--text-sub);">输入需要转换的文本（建议较长），选择配置后比较两者耗时。</p>

      <div class="options">
        <div>
          <label for="configName">配置（如 s2twp.json）</label>
          <input id="configName" value="s2twp.json"
            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: #f9fafb;" />
        </div>
      </div>

      <label for="inputText">输入文本</label>
      <textarea id="inputText" style="min-height: 120px;">鼠标里面的硅二极管坏了，导致光标分辨率降低。</textarea>

      <div class="toolbar">
        <button id="run" class="btn btn-primary">运行 Benchmark</button>
      </div>
    </div>

    <div class="card-section">
      <h2>结果</h2>
      <div class="output-box" id="output" style="min-height: 200px;"></div>
    </div>

    <div class="footer">
      本頁基於 <a href="https://www.npmjs.com/package/opencc-wasm" target="_blank" rel="noreferrer">opencc-wasm</a>
    </div>
  </div>

  <script type="module">
    import OpenCCWasm from "./vendor/opencc-wasm/esm/index.js";

    // 动态加载 opencc-js（仅从本地 vendor，未安装则给出提示）
    async function loadOpenCCJS() {
      const url = "./vendor/opencc-js/esm/full.js";
      let lastErr = null;
      try {
        const mod = await import(new URL(url, window.location.href).href);
        const api = mod.default || mod.OpenCC || mod;
        if (!api?.Converter) throw new Error("Converter not found in opencc-js module");
        return api;
      } catch (e) {
        lastErr = e;
      }
      throw lastErr || new Error("opencc-js not available");
    }

    async function runBenchmark(label, createConverter, input, lines) {
      try {
        const tLoad0 = performance.now();
        const conv = await createConverter();
        const tLoad1 = performance.now();

        await conv("預熱");

        const runs = [];
        let result = "";
        for (let i = 0; i < 5; i++) {
          const t0 = performance.now();
          result = await conv(input);
          const t1 = performance.now();
          runs.push(t1 - t0);
        }
        const avg = runs.reduce((a, b) => a + b, 0) / runs.length;
        lines.push(`${label} 加载: ${(tLoad1 - tLoad0).toFixed(2)} ms，转换(5次): ${runs.map(n => n.toFixed(2)).join(", ")} ms，平均: ${avg.toFixed(2)} ms`);
        lines.push(`${label} 输出: ${result}`);
      } catch (e) {
        lines.push(`${label} 失败: ${e}`);
        console.error(e);
      }
    }

    document.getElementById("run").onclick = async () => {
      const cfg = document.getElementById("configName").value.trim();
      const text = document.getElementById("inputText").value;
      const out = document.getElementById("output");
      if (!cfg) {
        out.textContent = "配置不能为空";
        return;
      }

      const lines = [];
      lines.push(`输入长度: ${text.length} 字符`);

      // WASM
      await runBenchmark(
        "WASM",
        () => OpenCCWasm.Converter({
          config: cfg,
          wasmPath: './vendor/opencc-wasm/dist/opencc-wasm.wasm'
        }),
        text,
        lines
      );

      // JS
      try {
        const OpenCCJS = await loadOpenCCJS();
        await runBenchmark(
          "opencc-js",
          () => OpenCCJS.Converter({ config: cfg }),
          text,
          lines
        );
      } catch (e) {
        lines.push("opencc-js 加载失败: " + e);
      }

      out.textContent = lines.join("\n");
    };
  </script>
</body>

</html>
